name: On Push

on:
  push:
    branches:
      - "**"
      - "!develop"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: self-hosted
    name: On Push

    steps:
      - name: Add path globally
        run: echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Add JAVA_HOME globally
        run: |
          echo "JAVA_HOME=$(/usr/libexec/java_home -v 17)" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: 'true'
          fetch-depth: 0

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2.9.0
        env:
          CI: true
        with:
          gradle-version: "wrapper"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.GITHUBRUNNER_EC2_ACTIONS_ROLE_ARN }}
          role-duration-seconds: 1200
          role-skip-session-tagging: true

      - name: Store GitHub actions ENV from AWS SecretManager
        id: secrets
        uses: say8425/aws-secrets-manager-actions@v2
        with:
          AWS_DEFAULT_REGION: "eu-west-2"
          SECRET_NAME: "di-ipv-dca-mob-android/github-actions-env"

      - name: Decode Keystore
        env:
          ENCODED_STRING: ${{ env.KEYSTORE_BASE64 }}
        run: |
          echo "${ENCODED_STRING}" | base64 --decode > config/keystore.jks

      - name: Decode Service Account
        env:
          ENCODED_STRING: ${{ env.SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          echo "${ENCODED_STRING}" | base64 --decode > config/service-account.json

      - name: Check
        run: |
          ./gradlew check detekt shellcheck verifyPaparazziDebug --stacktrace
        env:
          CI: true
          SIGNING_KEY_ALIAS: ${{ env.KEYSTORE_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ env.KEYSTORE_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
          READID_API_KEY: ${{ env.READID_API_KEY }}

      - name: Bundle build reports
        if: always()
        run: |
          zip -9 -r --exclude=**/build/reports/screenshots reports.zip **/build/reports

      - name: Upload build reports
        id: uploadBuildReports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: build-reports
          retention-days: 14
          path: |
            reports.zip
